<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>REPORT</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="REPORT_files/libs/clipboard/clipboard.min.js"></script>
<script src="REPORT_files/libs/quarto-html/quarto.js"></script>
<script src="REPORT_files/libs/quarto-html/popper.min.js"></script>
<script src="REPORT_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="REPORT_files/libs/quarto-html/anchor.min.js"></script>
<link href="REPORT_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="REPORT_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="REPORT_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="REPORT_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="REPORT_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

<link href="REPORT_files/libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">
<script src="REPORT_files/libs/pagedtable-1.1/js/pagedtable.js"></script>


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">REPORT</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="loading-the-data" class="level2">
<h2 class="anchored" data-anchor-id="loading-the-data">Loading the data</h2>
<p>Some boilerplate, libraries and loading. I will transform the columns type and postal_code into factors.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggpubr)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rsample)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vtreat)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(xgboost)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(skimr)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ROCR)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pROC)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SHAPforxgboost)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>party<span class="ot">=</span><span class="fu">read_csv</span>(<span class="st">"party.csv"</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>tx<span class="ot">=</span><span class="fu">read_csv</span>(<span class="st">"tx.csv"</span>)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>party<span class="sc">$</span>type<span class="ot">=</span><span class="fu">as_factor</span>(party<span class="sc">$</span>type)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>party<span class="sc">$</span>postal_code<span class="ot">=</span><span class="fu">as_factor</span>(party<span class="sc">$</span>postal_code)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="joining-the-tables" class="level2">
<h2 class="anchored" data-anchor-id="joining-the-tables">Joining the tables</h2>
<p>A quick inspection shows that the tx table only contains data from one date, 2023-10-25. We can also see that “party” has 12000 different ids, while “tx” has 8349 ids. So there will be cases of <strong>suspicious_label</strong> on ids that do not have any transaction(!).</p>
<p>Before joining, I will group “tx” by id and add some features to it, namely sum, mean, min, max, range, median absolute deviation (similar to standard deviation but avoids NAs in cases of just one transaction) and count.</p>
<p>Then I will join party and tx on id.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>tx_grp <span class="ot">=</span> tx <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">total=</span><span class="fu">sum</span>(tx), <span class="at">mean_tx=</span><span class="fu">mean</span>(tx), <span class="at">mad_tx=</span><span class="fu">mad</span>(tx), <span class="at">min_tx=</span><span class="fu">min</span>(tx), <span class="at">max_tx=</span><span class="fu">max</span>(tx), <span class="at">range=</span><span class="fu">max</span>(tx)<span class="sc">-</span><span class="fu">min</span>(tx), <span class="at">count_tx=</span><span class="fu">n</span>()) </span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> party <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(tx_grp, <span class="at">by=</span><span class="st">"id"</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["id"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["type"],"name":[2],"type":["fct"],"align":["left"]},{"label":["age"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["postal_code"],"name":[4],"type":["fct"],"align":["left"]},{"label":["suspicious_label"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["total"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["mean_tx"],"name":[7],"type":["dbl"],"align":["right"]},{"label":["mad_tx"],"name":[8],"type":["dbl"],"align":["right"]},{"label":["min_tx"],"name":[9],"type":["dbl"],"align":["right"]},{"label":["max_tx"],"name":[10],"type":["dbl"],"align":["right"]},{"label":["range"],"name":[11],"type":["dbl"],"align":["right"]},{"label":["count_tx"],"name":[12],"type":["int"],"align":["right"]}],"data":[{"1":"1","2":"private","3":"12","4":"70962","5":"0","6":"NA","7":"NA","8":"NA","9":"NA","10":"NA","11":"NA","12":"NA"},{"1":"2","2":"private","3":"11","4":"63657","5":"0","6":"515.09","7":"257.545","8":"263.4506","9":"79.85","10":"435.24","11":"355.39","12":"2"},{"1":"3","2":"private","3":"4","4":"62037","5":"0","6":"119.41","7":"119.410","8":"0.0000","9":"119.41","10":"119.41","11":"0.00","12":"1"},{"1":"4","2":"private","3":"9","4":"11728","5":"0","6":"451.20","7":"225.600","8":"113.5968","9":"148.98","10":"302.22","11":"153.24","12":"2"},{"1":"5","2":"private","3":"15","4":"63244","5":"0","6":"1077.33","7":"359.110","8":"134.1605","9":"90.54","10":"805.76","11":"715.22","12":"3"},{"1":"6","2":"private","3":"16","4":"11175","5":"NA","6":"NA","7":"NA","8":"NA","9":"NA","10":"NA","11":"NA","12":"NA"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">skim</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<caption>Data summary</caption>
<tbody>
<tr class="odd">
<td style="text-align: left;">Name</td>
<td style="text-align: left;">df</td>
</tr>
<tr class="even">
<td style="text-align: left;">Number of rows</td>
<td style="text-align: left;">12000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Number of columns</td>
<td style="text-align: left;">12</td>
</tr>
<tr class="even">
<td style="text-align: left;">_______________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Column type frequency:</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">factor</td>
<td style="text-align: left;">2</td>
</tr>
<tr class="odd">
<td style="text-align: left;">numeric</td>
<td style="text-align: left;">10</td>
</tr>
<tr class="even">
<td style="text-align: left;">________________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Group variables</td>
<td style="text-align: left;">None</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: factor</strong></p>
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 15%">
<col style="width: 11%">
<col style="width: 15%">
<col style="width: 9%">
<col style="width: 10%">
<col style="width: 37%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: left;">ordered</th>
<th style="text-align: right;">n_unique</th>
<th style="text-align: left;">top_counts</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">type</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">3</td>
<td style="text-align: left;">pri: 10000, sol: 1000, cor: 1000</td>
</tr>
<tr class="even">
<td style="text-align: left;">postal_code</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">9506</td>
<td style="text-align: left;">207: 5, 650: 5, 700: 5, 804: 5</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: numeric</strong></p>
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 16%">
<col style="width: 9%">
<col style="width: 13%">
<col style="width: 7%">
<col style="width: 8%">
<col style="width: 4%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 9%">
<col style="width: 5%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">p0</th>
<th style="text-align: right;">p25</th>
<th style="text-align: right;">p50</th>
<th style="text-align: right;">p75</th>
<th style="text-align: right;">p100</th>
<th style="text-align: left;">hist</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">id</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.0</td>
<td style="text-align: right;">6000.50</td>
<td style="text-align: right;">3464.25</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">3000.75</td>
<td style="text-align: right;">6000.50</td>
<td style="text-align: right;">9000.25</td>
<td style="text-align: right;">12000.0</td>
<td style="text-align: left;">▇▇▇▇▇</td>
</tr>
<tr class="even">
<td style="text-align: left;">age</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.0</td>
<td style="text-align: right;">42.21</td>
<td style="text-align: right;">20.97</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">25.00</td>
<td style="text-align: right;">40.00</td>
<td style="text-align: right;">58.00</td>
<td style="text-align: right;">111.0</td>
<td style="text-align: left;">▅▇▆▃▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">suspicious_label</td>
<td style="text-align: right;">3559</td>
<td style="text-align: right;">0.7</td>
<td style="text-align: right;">0.18</td>
<td style="text-align: right;">0.38</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.0</td>
<td style="text-align: left;">▇▁▁▁▂</td>
</tr>
<tr class="even">
<td style="text-align: left;">total</td>
<td style="text-align: right;">3651</td>
<td style="text-align: right;">0.7</td>
<td style="text-align: right;">1776.36</td>
<td style="text-align: right;">23975.41</td>
<td style="text-align: right;">8.46</td>
<td style="text-align: right;">183.12</td>
<td style="text-align: right;">438.42</td>
<td style="text-align: right;">1094.58</td>
<td style="text-align: right;">2035871.9</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">mean_tx</td>
<td style="text-align: right;">3651</td>
<td style="text-align: right;">0.7</td>
<td style="text-align: right;">766.25</td>
<td style="text-align: right;">4138.37</td>
<td style="text-align: right;">8.46</td>
<td style="text-align: right;">133.22</td>
<td style="text-align: right;">264.85</td>
<td style="text-align: right;">616.22</td>
<td style="text-align: right;">339312.0</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">mad_tx</td>
<td style="text-align: right;">3651</td>
<td style="text-align: right;">0.7</td>
<td style="text-align: right;">244.16</td>
<td style="text-align: right;">1157.08</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">149.02</td>
<td style="text-align: right;">57128.2</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">min_tx</td>
<td style="text-align: right;">3651</td>
<td style="text-align: right;">0.7</td>
<td style="text-align: right;">495.88</td>
<td style="text-align: right;">1448.17</td>
<td style="text-align: right;">5.22</td>
<td style="text-align: right;">77.25</td>
<td style="text-align: right;">163.55</td>
<td style="text-align: right;">408.42</td>
<td style="text-align: right;">82393.7</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">max_tx</td>
<td style="text-align: right;">3651</td>
<td style="text-align: right;">0.7</td>
<td style="text-align: right;">1231.47</td>
<td style="text-align: right;">14882.26</td>
<td style="text-align: right;">8.46</td>
<td style="text-align: right;">155.47</td>
<td style="text-align: right;">341.57</td>
<td style="text-align: right;">845.22</td>
<td style="text-align: right;">1288027.8</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">range</td>
<td style="text-align: right;">3651</td>
<td style="text-align: right;">0.7</td>
<td style="text-align: right;">735.59</td>
<td style="text-align: right;">13923.87</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">298.99</td>
<td style="text-align: right;">1205634.1</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">count_tx</td>
<td style="text-align: right;">3651</td>
<td style="text-align: right;">0.7</td>
<td style="text-align: right;">1.75</td>
<td style="text-align: right;">0.98</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">2.00</td>
<td style="text-align: right;">12.0</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>As previously mentioned, overall there are 17.55% of suspicious labels in the training set. However, for those ids with no transactions it is higher at 17.95%, while those with transactions are 17.37%</p>
<p><strong>This is a potential issue as some of the labels will be based only on demographics or previous knowledge not available to this model.</strong></p>
</section>
<section id="modeling" class="level2">
<h2 class="anchored" data-anchor-id="modeling">Modeling</h2>
<section id="data-prep" class="level3">
<h3 class="anchored" data-anchor-id="data-prep">Data Prep</h3>
<p>In order to model, I will</p>
<ul>
<li>substitute all NAs to the value -999 as imputing will not make sense, to be later used in XGBoost</li>
<li>convert type to dummy variables</li>
<li>remove id</li>
<li>remove postal_code as it is a factor with too many values and only a few repeat no more than 4 times, with high potential for overfitting.</li>
<li>separate into training and testing as per instructions (suspicious_label==NA)</li>
</ul>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>df[<span class="fu">is.na</span>(df)]<span class="ot">=</span><span class="sc">-</span><span class="dv">999</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>mk<span class="ot">=</span><span class="fu">designTreatmentsZ</span>(df,<span class="fu">colnames</span>(df)[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">4</span>)],<span class="at">verbose =</span> F, <span class="at">codeRestriction =</span> <span class="fu">c</span>(<span class="st">"lev"</span>,<span class="st">"clean"</span>))</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>df_prep<span class="ot">=</span><span class="fu">prepare</span>(mk,df)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>df_train<span class="ot">=</span>df_prep <span class="sc">%&gt;%</span> <span class="fu">filter</span>(suspicious_label<span class="sc">!=</span>(<span class="sc">-</span><span class="dv">999</span>))</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>df_test<span class="ot">=</span>df_prep <span class="sc">%&gt;%</span> <span class="fu">filter</span>(suspicious_label<span class="sc">==</span>(<span class="sc">-</span><span class="dv">999</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><strong>Another potential issue is Postal Code as in larger sets it might act as a demographic discriminant, also a lot of care should be done for those rare postal codes with pooling probably</strong></p>
</section>
<section id="model-prep-and-parameters" class="level3">
<h3 class="anchored" data-anchor-id="model-prep-and-parameters">Model prep and parameters</h3>
<p>Now that a training and testing sets are ready. Let’s further divide the training set into a train and validation sets (80/20) using stratified sampling. This will help avoid overfitting by stopping training once the validation set loss starts increasing.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>sp<span class="ot">=</span><span class="fu">initial_split</span>(df_train,<span class="at">prop=</span><span class="fl">0.8</span>,<span class="at">strata =</span> <span class="st">"suspicious_label"</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>train<span class="ot">=</span><span class="fu">training</span>(sp)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>valid<span class="ot">=</span><span class="fu">testing</span>(sp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Checking quickly, there are 17.54% suspicious labels in training and 17.58% in our validation set. As the data is fairly imbalanced, I will add weight to the positive labels (#negative/#positive). Also, as a further measure to avoid overfitting, I will add some random column sampling per tree. I’ll also convert the data to the XGBoost format.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>params<span class="ot">=</span><span class="fu">list</span>(<span class="at">objective=</span><span class="st">"binary:logistic"</span>, <span class="co">#classification</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">eta=</span><span class="fl">0.03</span>, <span class="co">#training rate, smaller to be slightly more accurate</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">eval_metric=</span><span class="fu">c</span>(<span class="st">"auc"</span>,<span class="st">"logloss"</span>), <span class="co">#standard loss, very affected by weights, AUC for control</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">scale_pos_weight=</span><span class="fu">sum</span>(train<span class="sc">$</span>suspicious_label<span class="sc">==</span><span class="dv">0</span>)<span class="sc">/</span><span class="fu">sum</span>(train<span class="sc">$</span>suspicious_label<span class="sc">==</span><span class="dv">1</span>), <span class="co">#weights</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">colsample_bytree=</span><span class="dv">1</span><span class="sc">-</span><span class="fu">exp</span>(<span class="sc">-</span><span class="dv">1</span>)) <span class="co">#sample columns at bootstrap limit</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>xgb_train<span class="ot">=</span><span class="fu">xgb.DMatrix</span>(<span class="fu">as.matrix</span>(train[,<span class="sc">-</span><span class="dv">2</span>]),<span class="at">label=</span>train<span class="sc">$</span>suspicious_label<span class="sc">==</span><span class="dv">1</span>,<span class="at">missing=</span><span class="sc">-</span><span class="dv">999</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>xgb_valid<span class="ot">=</span><span class="fu">xgb.DMatrix</span>(<span class="fu">as.matrix</span>(valid[,<span class="sc">-</span><span class="dv">2</span>]),<span class="at">label=</span>valid<span class="sc">$</span>suspicious_label<span class="sc">==</span><span class="dv">1</span>,<span class="at">missing=</span><span class="sc">-</span><span class="dv">999</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="training" class="level3">
<h3 class="anchored" data-anchor-id="training">Training</h3>
<p>Let’s go! When done, write the predictions to submit. Also look at AUC.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>xgb.model<span class="ot">=</span><span class="fu">xgb.train</span>(<span class="at">params =</span> params,</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> xgb_train,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">nrounds =</span> <span class="dv">1000</span>,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">early_stopping_rounds =</span> <span class="dv">15</span>,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">print_every_n =</span> <span class="dv">50</span>,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>                    <span class="at">watchlist =</span> <span class="fu">c</span>(<span class="at">valid=</span>xgb_valid))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] valid-auc:0.860416  valid-logloss:0.680302 
Multiple eval metrics are present. Will use valid_logloss for early stopping.
Will train until valid_logloss hasn't improved in 15 rounds.

[51]    valid-auc:0.936449  valid-logloss:0.381923 
[101]   valid-auc:0.938441  valid-logloss:0.331014 
[151]   valid-auc:0.939919  valid-logloss:0.317626 
[201]   valid-auc:0.941536  valid-logloss:0.311882 
[251]   valid-auc:0.942126  valid-logloss:0.309999 
[301]   valid-auc:0.943026  valid-logloss:0.308682 
[351]   valid-auc:0.943077  valid-logloss:0.307827 
Stopping. Best iteration:
[375]   valid-auc:0.943367  valid-logloss:0.307234</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>pred_valid<span class="ot">=</span><span class="fu">predict</span>(xgb.model,xgb_valid)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>pred_test<span class="ot">=</span><span class="fu">predict</span>(xgb.model,<span class="fu">as.matrix</span>(df_test[,<span class="sc">-</span><span class="dv">2</span>]))</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>submit<span class="ot">=</span><span class="fu">tibble</span>(<span class="at">id=</span>df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(suspicious_label<span class="sc">==-</span><span class="dv">999</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(id),<span class="at">score=</span>pred_test)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(submit,<span class="st">"test-predictions.csv"</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(valid <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">Response=</span>suspicious_label),<span class="st">"newdata.csv"</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="fu">xgb.save</span>(xgb.model,<span class="st">"model.json"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>roc<span class="ot">=</span><span class="fu">roc</span>(valid[,<span class="dv">2</span>],pred_valid,<span class="at">plot=</span>T,<span class="at">ci=</span>T,<span class="at">smooth=</span>F,<span class="at">auc=</span>T,<span class="at">print.auc=</span>T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Setting levels: control = 0, case = 1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Setting direction: controls &lt; cases</code></pre>
</div>
<div class="cell-output-display">
<p><img src="REPORT_files/figure-html/model_train-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="interpretation" class="level3">
<h3 class="anchored" data-anchor-id="interpretation">Interpretation</h3>
<p>Let’s look at the SHAP summary plot and dependence plots for the top 3 variables.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">shap.plot.summary.wrap1</span>(xgb.model,<span class="at">X =</span> <span class="fu">as.matrix</span>(valid[,<span class="sc">-</span><span class="dv">2</span>]))<span class="sc">+</span><span class="fu">ggtitle</span>(<span class="st">"SHAP Summary Plot"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="REPORT_files/figure-html/figures-1.png" class="img-fluid" width="672"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>shap_long<span class="ot">=</span><span class="fu">shap.prep</span>(xgb.model,<span class="at">X_train =</span> <span class="fu">as.matrix</span>(valid[,<span class="sc">-</span><span class="dv">2</span>]))</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>int<span class="ot">=</span><span class="fu">shap.prep.interaction</span>(xgb.model,<span class="fu">as.matrix</span>(valid[,<span class="sc">-</span><span class="dv">2</span>]))</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>p1<span class="ot">=</span><span class="fu">shap.plot.dependence</span>(shap_long,<span class="st">"age"</span>,<span class="at">data_int =</span> int,<span class="at">smooth=</span>F)<span class="sc">+</span><span class="fu">ggtitle</span>(<span class="st">"Pure Age"</span>)<span class="sc">+</span><span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">7</span>,<span class="dv">3</span>))<span class="sc">+</span><span class="fu">theme</span>(<span class="at">axis.title.y =</span> <span class="fu">element_blank</span>())</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>p2<span class="ot">=</span><span class="fu">shap.plot.dependence</span>(shap_long,<span class="st">"age"</span>,<span class="at">smooth=</span>F)<span class="sc">+</span><span class="fu">ggtitle</span>(<span class="st">"Age Marginal"</span>)<span class="sc">+</span><span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">7</span>,<span class="dv">3</span>))<span class="sc">+</span><span class="fu">theme</span>(<span class="at">axis.title.y =</span> <span class="fu">element_blank</span>())</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>p3<span class="ot">=</span><span class="fu">shap.plot.dependence</span>(shap_long,<span class="st">"min_tx"</span>,<span class="at">data_int=</span>int,<span class="at">smooth=</span>F)<span class="sc">+</span><span class="fu">scale_x_log10</span>(<span class="at">breaks=</span><span class="fu">seq</span>(<span class="dv">300</span>,<span class="dv">400</span>,<span class="at">by=</span><span class="dv">100</span>))<span class="sc">+</span><span class="fu">ggtitle</span>(<span class="st">"Pure Min_Tx (log)"</span>)<span class="sc">+</span><span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span>,<span class="dv">2</span>))<span class="sc">+</span><span class="fu">theme</span>(<span class="at">axis.title.y =</span> <span class="fu">element_blank</span>(),<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle=</span><span class="dv">90</span>,<span class="at">vjust =</span> .<span class="dv">5</span>))</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>p4<span class="ot">=</span><span class="fu">shap.plot.dependence</span>(shap_long,<span class="st">"min_tx"</span>,<span class="at">smooth=</span>F)<span class="sc">+</span><span class="fu">scale_x_log10</span>(<span class="at">breaks=</span><span class="fu">seq</span>(<span class="dv">300</span>,<span class="dv">400</span>,<span class="at">by=</span><span class="dv">100</span>))<span class="sc">+</span><span class="fu">ggtitle</span>(<span class="st">"Min Tx Marginal (log)"</span>)<span class="sc">+</span><span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span>,<span class="dv">2</span>))<span class="sc">+</span><span class="fu">theme</span>(<span class="at">axis.title.y =</span> <span class="fu">element_blank</span>(),<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle=</span><span class="dv">90</span>,<span class="at">vjust =</span> .<span class="dv">5</span>))</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>p5<span class="ot">=</span><span class="fu">shap.plot.dependence</span>(shap_long,<span class="st">"mean_tx"</span>,<span class="at">data_int=</span>int,<span class="at">smooth=</span>F)<span class="sc">+</span><span class="fu">scale_x_log10</span>(<span class="at">breaks=</span><span class="fu">seq</span>(<span class="dv">600</span>,<span class="dv">800</span>,<span class="at">by=</span><span class="dv">200</span>))<span class="sc">+</span><span class="fu">ggtitle</span>(<span class="st">"Pure Mean_Tx (log)"</span>)<span class="sc">+</span><span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span>,<span class="dv">3</span>))<span class="sc">+</span><span class="fu">theme</span>(<span class="at">axis.title.y =</span> <span class="fu">element_blank</span>(),<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle=</span><span class="dv">90</span>,<span class="at">vjust =</span> .<span class="dv">5</span>))</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>p6<span class="ot">=</span><span class="fu">shap.plot.dependence</span>(shap_long,<span class="st">"mean_tx"</span>,<span class="at">smooth=</span>F)<span class="sc">+</span><span class="fu">scale_x_log10</span>(<span class="at">breaks=</span><span class="fu">seq</span>(<span class="dv">600</span>,<span class="dv">800</span>,<span class="at">by=</span><span class="dv">200</span>))<span class="sc">+</span><span class="fu">ggtitle</span>(<span class="st">"Mean Tx Marginal (log)"</span>)<span class="sc">+</span><span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span>,<span class="dv">3</span>))<span class="sc">+</span><span class="fu">theme</span>(<span class="at">axis.title.y =</span> <span class="fu">element_blank</span>(),<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle=</span><span class="dv">90</span>,<span class="at">vjust =</span> .<span class="dv">5</span>))</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>p<span class="ot">=</span><span class="fu">ggarrange</span>(p1,p2,p3,p4,p5,p6,<span class="at">nrow=</span><span class="dv">3</span>,<span class="at">ncol=</span><span class="dv">2</span>,<span class="at">align =</span> <span class="st">"hv"</span>)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="REPORT_files/figure-html/figures-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>From these graphs we can see that this model is highly discriminating for age. If you are young, you are likely suspicious, while if over 60, you are 5 to 6 <strong><em>orders of magnitude</em></strong> less likely to be found suspicious.</p>
<p>Also, the model finds the minimum transaction amount to be very important, with somewhere around 300-400 making it more likely to have a suspicious label. The mean transaction amount is found to behave similarly, but with a breaking point around 600-800. It is interesting to see that due to the presence of other variables, the pure effect of mean_tx is brought down in the marginal. This is likely due to the presence of highly correlated variables like min_tx.</p>
<p>Both variables seem to have a log-linear behavior, this seems to indicate that orders of magnitude of the transactions should be treated similarly and could be a potential engineered feature.</p>
</section>
</section>
<section id="model-metrics" class="level2">
<h2 class="anchored" data-anchor-id="model-metrics">Model metrics</h2>
<p>For this problem, I would suggest that a precision recall break-even threshold be selected. This ensures that we are right sizing the effort and not sacrificing either precision or recall. However, because this is a problem where recall is fundamental, I would also suggest investigating some negatives. This could be done by pure probability sampling or ordering by some measure like “probability*amount”.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>pred<span class="ot">=</span><span class="fu">prediction</span>(<span class="at">predictions =</span> pred_valid, <span class="at">labels =</span> valid<span class="sc">$</span>suspicious_label)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>perf<span class="ot">=</span><span class="fu">performance</span>(pred,<span class="at">measure =</span> <span class="st">"prbe"</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>thresh<span class="ot">=</span>perf<span class="sc">@</span>x.values[[<span class="dv">1</span>]][<span class="fu">which.max</span>(perf<span class="sc">@</span>y.values[[<span class="dv">1</span>]])]</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>tp<span class="ot">=</span><span class="fu">sum</span>((pred_valid<span class="sc">&gt;=</span>thresh) <span class="sc">&amp;</span> (valid<span class="sc">$</span>suspicious_label<span class="sc">==</span><span class="dv">1</span>))</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>tn<span class="ot">=</span><span class="fu">sum</span>((pred_valid<span class="sc">&lt;</span>thresh) <span class="sc">&amp;</span> (valid<span class="sc">$</span>suspicious_label<span class="sc">==</span><span class="dv">0</span>))</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>fp<span class="ot">=</span><span class="fu">sum</span>((pred_valid<span class="sc">&gt;=</span>thresh) <span class="sc">&amp;</span> (valid<span class="sc">$</span>suspicious_label<span class="sc">==</span><span class="dv">0</span>))</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>fn<span class="ot">=</span><span class="fu">sum</span>((pred_valid<span class="sc">&lt;</span>thresh) <span class="sc">&amp;</span> (valid<span class="sc">$</span>suspicious_label<span class="sc">==</span><span class="dv">1</span>))</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>accuracy<span class="ot">=</span>(tn<span class="sc">+</span>tp)<span class="sc">/</span><span class="fu">nrow</span>(valid)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>precision<span class="ot">=</span>tp<span class="sc">/</span>(tp<span class="sc">+</span>fp)</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>recall<span class="ot">=</span>tp<span class="sc">/</span>(tp<span class="sc">+</span>fn)</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Confusion Matrix"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Confusion Matrix"</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(<span class="at">pred=</span>pred_valid<span class="sc">&gt;=</span>thresh,<span class="at">actual=</span>valid<span class="sc">$</span>suspicious_label)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>       actual
pred       0    1
  FALSE 1303   90
  TRUE    89  207</code></pre>
</div>
</div>
<p>In this case the threshold is 0.757 for which accuracy is 0.894, precision is 0.699 and recall is 0.697. A priori, saying no one is suspicious, accuracy would be 0.824.</p>
</section>
<section id="conclusions-and-further-work" class="level2">
<h2 class="anchored" data-anchor-id="conclusions-and-further-work">Conclusions and further work</h2>
<p>This is in principle a good model, an AUC over 0.9, (much) improved accuracy and reasonable precision and recall.</p>
<p>However, there are many amber to red flags which I believe make it a “no go”.</p>
<p>The model classifies quite well ids with no transaction information. Purely based on demographics, which raises potential discriminatory problems. In this case, only a limited range of ages is likely to be flagged as suspicious.</p>
<p>The presence of postal code can also raise potential discriminatory issues. In countries where there is a long established record of race segregation, a postal code is a proxy for race and average income. And in other places, it could be a proxy for immigration status as well.</p>
<p>Before thinking about deploying, I would really like to gather more historical transaction data, and also other indicators of a user’s real financial situation, salary, mortgage, credit score, debt, etc. Also, I would like to understand why some ids with no transaction data are labeled as suspicious, is it historical? Have they defaulted previously? Are they in a collection process? Have they ever been?</p>
<p>Once this is done and the new model has good performance, I would deploy by using a managed platform (Azure, AWS, GCP). This can be either a batch process or a REST API on a web service, depending on the need for real time predictions. The advantage of this approach is that you can have version control, rapid rollbacks etc, as well as the CI/CD environment. The steps are the usual, containerize the model and potentially the feature engineering (Docker), create the ETL flow (can also contain part of the feature engineering), schedule batch processing or serve the API.</p>
<!-- -->

</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb20" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "REPORT"</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span><span class="co"> </span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="co">    df-print: paged</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="fu">## Loading the data</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>Some boilerplate, libraries and loading. I will transform the columns type and postal_code into factors.</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: loading_data</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggpubr)</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rsample)</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vtreat)</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(xgboost)</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(skimr)</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ROCR)</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pROC)</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SHAPforxgboost)</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>party<span class="ot">=</span><span class="fu">read_csv</span>(<span class="st">"party.csv"</span>)</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>tx<span class="ot">=</span><span class="fu">read_csv</span>(<span class="st">"tx.csv"</span>)</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>party<span class="sc">$</span>type<span class="ot">=</span><span class="fu">as_factor</span>(party<span class="sc">$</span>type)</span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>party<span class="sc">$</span>postal_code<span class="ot">=</span><span class="fu">as_factor</span>(party<span class="sc">$</span>postal_code)</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a><span class="fu">## Joining the tables</span></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>A quick inspection shows that the tx table only contains data from one date, <span class="in">`r unique(tx$date)`</span>. We can also see that "party" has <span class="in">`r length(unique(party$id))`</span> different ids, while "tx" has <span class="in">`r length(unique(tx$id))`</span> ids. So there will be cases of **suspicious_label** on ids that do not have any transaction(!).</span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>Before joining, I will group "tx" by id and add some features to it, namely sum, mean, min, max, range, median absolute deviation (similar to standard deviation but avoids NAs in cases of just one transaction) and count.</span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>Then I will join party and tx on id.</span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: feature_eng</span></span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>tx_grp <span class="ot">=</span> tx <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">total=</span><span class="fu">sum</span>(tx), <span class="at">mean_tx=</span><span class="fu">mean</span>(tx), <span class="at">mad_tx=</span><span class="fu">mad</span>(tx), <span class="at">min_tx=</span><span class="fu">min</span>(tx), <span class="at">max_tx=</span><span class="fu">max</span>(tx), <span class="at">range=</span><span class="fu">max</span>(tx)<span class="sc">-</span><span class="fu">min</span>(tx), <span class="at">count_tx=</span><span class="fu">n</span>()) </span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> party <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(tx_grp, <span class="at">by=</span><span class="st">"id"</span>)</span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df)</span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a><span class="fu">skim</span>(df)</span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a>As previously mentioned, overall there are <span class="in">`r round(100*mean(party$suspicious_label,na.rm=T),2)`</span>% of suspicious labels in the training set. However, for those ids with no transactions it is higher at <span class="in">`r round(100*mean(df$suspicious_label[is.na(df$total)],na.rm=T),2)`</span>%, while those with transactions are <span class="in">`r round(100*mean(df$suspicious_label[!is.na(df$total)],na.rm=T),2)`</span>%</span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a>**This is a potential issue as some of the labels will be based only on demographics or previous knowledge not available to this model.**</span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a><span class="fu">## Modeling</span></span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true" tabindex="-1"></a><span class="fu">### Data Prep</span></span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-60"><a href="#cb20-60" aria-hidden="true" tabindex="-1"></a>In order to model, I will</span>
<span id="cb20-61"><a href="#cb20-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-62"><a href="#cb20-62" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>substitute all NAs to the value -999 as imputing will not make sense, to be later used in XGBoost</span>
<span id="cb20-63"><a href="#cb20-63" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>convert type to dummy variables</span>
<span id="cb20-64"><a href="#cb20-64" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>remove id</span>
<span id="cb20-65"><a href="#cb20-65" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>remove postal_code as it is a factor with too many values and only a few repeat no more than 4 times, with high potential for overfitting.</span>
<span id="cb20-66"><a href="#cb20-66" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>separate into training and testing as per instructions (suspicious_label==NA)</span>
<span id="cb20-67"><a href="#cb20-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-70"><a href="#cb20-70" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb20-71"><a href="#cb20-71" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb20-72"><a href="#cb20-72" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: preparation</span></span>
<span id="cb20-73"><a href="#cb20-73" aria-hidden="true" tabindex="-1"></a>df[<span class="fu">is.na</span>(df)]<span class="ot">=</span><span class="sc">-</span><span class="dv">999</span></span>
<span id="cb20-74"><a href="#cb20-74" aria-hidden="true" tabindex="-1"></a>mk<span class="ot">=</span><span class="fu">designTreatmentsZ</span>(df,<span class="fu">colnames</span>(df)[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">4</span>)],<span class="at">verbose =</span> F, <span class="at">codeRestriction =</span> <span class="fu">c</span>(<span class="st">"lev"</span>,<span class="st">"clean"</span>))</span>
<span id="cb20-75"><a href="#cb20-75" aria-hidden="true" tabindex="-1"></a>df_prep<span class="ot">=</span><span class="fu">prepare</span>(mk,df)</span>
<span id="cb20-76"><a href="#cb20-76" aria-hidden="true" tabindex="-1"></a>df_train<span class="ot">=</span>df_prep <span class="sc">%&gt;%</span> <span class="fu">filter</span>(suspicious_label<span class="sc">!=</span>(<span class="sc">-</span><span class="dv">999</span>))</span>
<span id="cb20-77"><a href="#cb20-77" aria-hidden="true" tabindex="-1"></a>df_test<span class="ot">=</span>df_prep <span class="sc">%&gt;%</span> <span class="fu">filter</span>(suspicious_label<span class="sc">==</span>(<span class="sc">-</span><span class="dv">999</span>))</span>
<span id="cb20-78"><a href="#cb20-78" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-79"><a href="#cb20-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-80"><a href="#cb20-80" aria-hidden="true" tabindex="-1"></a>**Another potential issue is Postal Code as in larger sets it might act as a demographic discriminant, also a lot of care should be done for those rare postal codes with pooling probably**</span>
<span id="cb20-81"><a href="#cb20-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-82"><a href="#cb20-82" aria-hidden="true" tabindex="-1"></a><span class="fu">### Model prep and parameters</span></span>
<span id="cb20-83"><a href="#cb20-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-84"><a href="#cb20-84" aria-hidden="true" tabindex="-1"></a>Now that a training and testing sets are ready. Let's further divide the training set into a train and validation sets (80/20) using stratified sampling. This will help avoid overfitting by stopping training once the validation set loss starts increasing.</span>
<span id="cb20-85"><a href="#cb20-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-88"><a href="#cb20-88" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb20-89"><a href="#cb20-89" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: test_valid</span></span>
<span id="cb20-90"><a href="#cb20-90" aria-hidden="true" tabindex="-1"></a>sp<span class="ot">=</span><span class="fu">initial_split</span>(df_train,<span class="at">prop=</span><span class="fl">0.8</span>,<span class="at">strata =</span> <span class="st">"suspicious_label"</span>)</span>
<span id="cb20-91"><a href="#cb20-91" aria-hidden="true" tabindex="-1"></a>train<span class="ot">=</span><span class="fu">training</span>(sp)</span>
<span id="cb20-92"><a href="#cb20-92" aria-hidden="true" tabindex="-1"></a>valid<span class="ot">=</span><span class="fu">testing</span>(sp)</span>
<span id="cb20-93"><a href="#cb20-93" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-94"><a href="#cb20-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-95"><a href="#cb20-95" aria-hidden="true" tabindex="-1"></a>Checking quickly, there are <span class="in">`r round(100*mean(train$suspicious_label),2)`</span>% suspicious labels in training and <span class="in">`r round(100*mean(valid$suspicious_label),2)`</span>% in our validation set. As the data is fairly imbalanced, I will add weight to the positive labels (#negative/#positive). Also, as a further measure to avoid overfitting, I will add some random column sampling per tree. I'll also convert the data to the XGBoost format.</span>
<span id="cb20-96"><a href="#cb20-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-99"><a href="#cb20-99" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb20-100"><a href="#cb20-100" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: model_params</span></span>
<span id="cb20-101"><a href="#cb20-101" aria-hidden="true" tabindex="-1"></a>params<span class="ot">=</span><span class="fu">list</span>(<span class="at">objective=</span><span class="st">"binary:logistic"</span>, <span class="co">#classification</span></span>
<span id="cb20-102"><a href="#cb20-102" aria-hidden="true" tabindex="-1"></a>            <span class="at">eta=</span><span class="fl">0.03</span>, <span class="co">#training rate, smaller to be slightly more accurate</span></span>
<span id="cb20-103"><a href="#cb20-103" aria-hidden="true" tabindex="-1"></a>            <span class="at">eval_metric=</span><span class="fu">c</span>(<span class="st">"auc"</span>,<span class="st">"logloss"</span>), <span class="co">#standard loss, very affected by weights, AUC for control</span></span>
<span id="cb20-104"><a href="#cb20-104" aria-hidden="true" tabindex="-1"></a>            <span class="at">scale_pos_weight=</span><span class="fu">sum</span>(train<span class="sc">$</span>suspicious_label<span class="sc">==</span><span class="dv">0</span>)<span class="sc">/</span><span class="fu">sum</span>(train<span class="sc">$</span>suspicious_label<span class="sc">==</span><span class="dv">1</span>), <span class="co">#weights</span></span>
<span id="cb20-105"><a href="#cb20-105" aria-hidden="true" tabindex="-1"></a>            <span class="at">colsample_bytree=</span><span class="dv">1</span><span class="sc">-</span><span class="fu">exp</span>(<span class="sc">-</span><span class="dv">1</span>)) <span class="co">#sample columns at bootstrap limit</span></span>
<span id="cb20-106"><a href="#cb20-106" aria-hidden="true" tabindex="-1"></a>xgb_train<span class="ot">=</span><span class="fu">xgb.DMatrix</span>(<span class="fu">as.matrix</span>(train[,<span class="sc">-</span><span class="dv">2</span>]),<span class="at">label=</span>train<span class="sc">$</span>suspicious_label<span class="sc">==</span><span class="dv">1</span>,<span class="at">missing=</span><span class="sc">-</span><span class="dv">999</span>)</span>
<span id="cb20-107"><a href="#cb20-107" aria-hidden="true" tabindex="-1"></a>xgb_valid<span class="ot">=</span><span class="fu">xgb.DMatrix</span>(<span class="fu">as.matrix</span>(valid[,<span class="sc">-</span><span class="dv">2</span>]),<span class="at">label=</span>valid<span class="sc">$</span>suspicious_label<span class="sc">==</span><span class="dv">1</span>,<span class="at">missing=</span><span class="sc">-</span><span class="dv">999</span>)</span>
<span id="cb20-108"><a href="#cb20-108" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-109"><a href="#cb20-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-110"><a href="#cb20-110" aria-hidden="true" tabindex="-1"></a><span class="fu">### Training</span></span>
<span id="cb20-111"><a href="#cb20-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-112"><a href="#cb20-112" aria-hidden="true" tabindex="-1"></a>Let's go! When done, write the predictions to submit. Also look at AUC.</span>
<span id="cb20-113"><a href="#cb20-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-116"><a href="#cb20-116" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb20-117"><a href="#cb20-117" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: model_train</span></span>
<span id="cb20-118"><a href="#cb20-118" aria-hidden="true" tabindex="-1"></a>xgb.model<span class="ot">=</span><span class="fu">xgb.train</span>(<span class="at">params =</span> params,</span>
<span id="cb20-119"><a href="#cb20-119" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> xgb_train,</span>
<span id="cb20-120"><a href="#cb20-120" aria-hidden="true" tabindex="-1"></a>                    <span class="at">nrounds =</span> <span class="dv">1000</span>,</span>
<span id="cb20-121"><a href="#cb20-121" aria-hidden="true" tabindex="-1"></a>                    <span class="at">early_stopping_rounds =</span> <span class="dv">15</span>,</span>
<span id="cb20-122"><a href="#cb20-122" aria-hidden="true" tabindex="-1"></a>                    <span class="at">print_every_n =</span> <span class="dv">50</span>,</span>
<span id="cb20-123"><a href="#cb20-123" aria-hidden="true" tabindex="-1"></a>                    <span class="at">watchlist =</span> <span class="fu">c</span>(<span class="at">valid=</span>xgb_valid))</span>
<span id="cb20-124"><a href="#cb20-124" aria-hidden="true" tabindex="-1"></a>pred_valid<span class="ot">=</span><span class="fu">predict</span>(xgb.model,xgb_valid)</span>
<span id="cb20-125"><a href="#cb20-125" aria-hidden="true" tabindex="-1"></a>pred_test<span class="ot">=</span><span class="fu">predict</span>(xgb.model,<span class="fu">as.matrix</span>(df_test[,<span class="sc">-</span><span class="dv">2</span>]))</span>
<span id="cb20-126"><a href="#cb20-126" aria-hidden="true" tabindex="-1"></a>submit<span class="ot">=</span><span class="fu">tibble</span>(<span class="at">id=</span>df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(suspicious_label<span class="sc">==-</span><span class="dv">999</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(id),<span class="at">score=</span>pred_test)</span>
<span id="cb20-127"><a href="#cb20-127" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(submit,<span class="st">"test-predictions.csv"</span>)</span>
<span id="cb20-128"><a href="#cb20-128" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(valid <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">Response=</span>suspicious_label),<span class="st">"newdata.csv"</span>)</span>
<span id="cb20-129"><a href="#cb20-129" aria-hidden="true" tabindex="-1"></a><span class="fu">xgb.save</span>(xgb.model,<span class="st">"model.json"</span>)</span>
<span id="cb20-130"><a href="#cb20-130" aria-hidden="true" tabindex="-1"></a>roc<span class="ot">=</span><span class="fu">roc</span>(valid[,<span class="dv">2</span>],pred_valid,<span class="at">plot=</span>T,<span class="at">ci=</span>T,<span class="at">smooth=</span>F,<span class="at">auc=</span>T,<span class="at">print.auc=</span>T)</span>
<span id="cb20-131"><a href="#cb20-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-132"><a href="#cb20-132" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-133"><a href="#cb20-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-134"><a href="#cb20-134" aria-hidden="true" tabindex="-1"></a><span class="fu">### Interpretation</span></span>
<span id="cb20-135"><a href="#cb20-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-136"><a href="#cb20-136" aria-hidden="true" tabindex="-1"></a>Let's look at the SHAP summary plot and dependence plots for the top 3 variables.</span>
<span id="cb20-137"><a href="#cb20-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-140"><a href="#cb20-140" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb20-141"><a href="#cb20-141" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: figures</span></span>
<span id="cb20-142"><a href="#cb20-142" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb20-143"><a href="#cb20-143" aria-hidden="true" tabindex="-1"></a><span class="fu">shap.plot.summary.wrap1</span>(xgb.model,<span class="at">X =</span> <span class="fu">as.matrix</span>(valid[,<span class="sc">-</span><span class="dv">2</span>]))<span class="sc">+</span><span class="fu">ggtitle</span>(<span class="st">"SHAP Summary Plot"</span>)</span>
<span id="cb20-144"><a href="#cb20-144" aria-hidden="true" tabindex="-1"></a>shap_long<span class="ot">=</span><span class="fu">shap.prep</span>(xgb.model,<span class="at">X_train =</span> <span class="fu">as.matrix</span>(valid[,<span class="sc">-</span><span class="dv">2</span>]))</span>
<span id="cb20-145"><a href="#cb20-145" aria-hidden="true" tabindex="-1"></a>int<span class="ot">=</span><span class="fu">shap.prep.interaction</span>(xgb.model,<span class="fu">as.matrix</span>(valid[,<span class="sc">-</span><span class="dv">2</span>]))</span>
<span id="cb20-146"><a href="#cb20-146" aria-hidden="true" tabindex="-1"></a>p1<span class="ot">=</span><span class="fu">shap.plot.dependence</span>(shap_long,<span class="st">"age"</span>,<span class="at">data_int =</span> int,<span class="at">smooth=</span>F)<span class="sc">+</span><span class="fu">ggtitle</span>(<span class="st">"Pure Age"</span>)<span class="sc">+</span><span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">7</span>,<span class="dv">3</span>))<span class="sc">+</span><span class="fu">theme</span>(<span class="at">axis.title.y =</span> <span class="fu">element_blank</span>())</span>
<span id="cb20-147"><a href="#cb20-147" aria-hidden="true" tabindex="-1"></a>p2<span class="ot">=</span><span class="fu">shap.plot.dependence</span>(shap_long,<span class="st">"age"</span>,<span class="at">smooth=</span>F)<span class="sc">+</span><span class="fu">ggtitle</span>(<span class="st">"Age Marginal"</span>)<span class="sc">+</span><span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">7</span>,<span class="dv">3</span>))<span class="sc">+</span><span class="fu">theme</span>(<span class="at">axis.title.y =</span> <span class="fu">element_blank</span>())</span>
<span id="cb20-148"><a href="#cb20-148" aria-hidden="true" tabindex="-1"></a>p3<span class="ot">=</span><span class="fu">shap.plot.dependence</span>(shap_long,<span class="st">"min_tx"</span>,<span class="at">data_int=</span>int,<span class="at">smooth=</span>F)<span class="sc">+</span><span class="fu">scale_x_log10</span>(<span class="at">breaks=</span><span class="fu">seq</span>(<span class="dv">300</span>,<span class="dv">400</span>,<span class="at">by=</span><span class="dv">100</span>))<span class="sc">+</span><span class="fu">ggtitle</span>(<span class="st">"Pure Min_Tx (log)"</span>)<span class="sc">+</span><span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span>,<span class="dv">2</span>))<span class="sc">+</span><span class="fu">theme</span>(<span class="at">axis.title.y =</span> <span class="fu">element_blank</span>(),<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle=</span><span class="dv">90</span>,<span class="at">vjust =</span> .<span class="dv">5</span>))</span>
<span id="cb20-149"><a href="#cb20-149" aria-hidden="true" tabindex="-1"></a>p4<span class="ot">=</span><span class="fu">shap.plot.dependence</span>(shap_long,<span class="st">"min_tx"</span>,<span class="at">smooth=</span>F)<span class="sc">+</span><span class="fu">scale_x_log10</span>(<span class="at">breaks=</span><span class="fu">seq</span>(<span class="dv">300</span>,<span class="dv">400</span>,<span class="at">by=</span><span class="dv">100</span>))<span class="sc">+</span><span class="fu">ggtitle</span>(<span class="st">"Min Tx Marginal (log)"</span>)<span class="sc">+</span><span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span>,<span class="dv">2</span>))<span class="sc">+</span><span class="fu">theme</span>(<span class="at">axis.title.y =</span> <span class="fu">element_blank</span>(),<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle=</span><span class="dv">90</span>,<span class="at">vjust =</span> .<span class="dv">5</span>))</span>
<span id="cb20-150"><a href="#cb20-150" aria-hidden="true" tabindex="-1"></a>p5<span class="ot">=</span><span class="fu">shap.plot.dependence</span>(shap_long,<span class="st">"mean_tx"</span>,<span class="at">data_int=</span>int,<span class="at">smooth=</span>F)<span class="sc">+</span><span class="fu">scale_x_log10</span>(<span class="at">breaks=</span><span class="fu">seq</span>(<span class="dv">600</span>,<span class="dv">800</span>,<span class="at">by=</span><span class="dv">200</span>))<span class="sc">+</span><span class="fu">ggtitle</span>(<span class="st">"Pure Mean_Tx (log)"</span>)<span class="sc">+</span><span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span>,<span class="dv">3</span>))<span class="sc">+</span><span class="fu">theme</span>(<span class="at">axis.title.y =</span> <span class="fu">element_blank</span>(),<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle=</span><span class="dv">90</span>,<span class="at">vjust =</span> .<span class="dv">5</span>))</span>
<span id="cb20-151"><a href="#cb20-151" aria-hidden="true" tabindex="-1"></a>p6<span class="ot">=</span><span class="fu">shap.plot.dependence</span>(shap_long,<span class="st">"mean_tx"</span>,<span class="at">smooth=</span>F)<span class="sc">+</span><span class="fu">scale_x_log10</span>(<span class="at">breaks=</span><span class="fu">seq</span>(<span class="dv">600</span>,<span class="dv">800</span>,<span class="at">by=</span><span class="dv">200</span>))<span class="sc">+</span><span class="fu">ggtitle</span>(<span class="st">"Mean Tx Marginal (log)"</span>)<span class="sc">+</span><span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span>,<span class="dv">3</span>))<span class="sc">+</span><span class="fu">theme</span>(<span class="at">axis.title.y =</span> <span class="fu">element_blank</span>(),<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle=</span><span class="dv">90</span>,<span class="at">vjust =</span> .<span class="dv">5</span>))</span>
<span id="cb20-152"><a href="#cb20-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-153"><a href="#cb20-153" aria-hidden="true" tabindex="-1"></a>p<span class="ot">=</span><span class="fu">ggarrange</span>(p1,p2,p3,p4,p5,p6,<span class="at">nrow=</span><span class="dv">3</span>,<span class="at">ncol=</span><span class="dv">2</span>,<span class="at">align =</span> <span class="st">"hv"</span>)</span>
<span id="cb20-154"><a href="#cb20-154" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(p)</span>
<span id="cb20-155"><a href="#cb20-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-156"><a href="#cb20-156" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-157"><a href="#cb20-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-158"><a href="#cb20-158" aria-hidden="true" tabindex="-1"></a>From these graphs we can see that this model is highly discriminating for age. If you are young, you are likely suspicious, while if over 60, you are 5 to 6 ***orders of magnitude*** less likely to be found suspicious.</span>
<span id="cb20-159"><a href="#cb20-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-160"><a href="#cb20-160" aria-hidden="true" tabindex="-1"></a>Also, the model finds the minimum transaction amount to be very important, with somewhere around 300-400 making it more likely to have a suspicious label. The mean transaction amount is found to behave similarly, but with a breaking point around 600-800. It is interesting to see that due to the presence of other variables, the pure effect of mean_tx is brought down in the marginal. This is likely due to the presence of highly correlated variables like min_tx.</span>
<span id="cb20-161"><a href="#cb20-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-162"><a href="#cb20-162" aria-hidden="true" tabindex="-1"></a>Both variables seem to have a log-linear behavior, this seems to indicate that orders of magnitude of the transactions should be treated similarly and could be a potential engineered feature.</span>
<span id="cb20-163"><a href="#cb20-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-164"><a href="#cb20-164" aria-hidden="true" tabindex="-1"></a><span class="fu">## Model metrics</span></span>
<span id="cb20-165"><a href="#cb20-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-166"><a href="#cb20-166" aria-hidden="true" tabindex="-1"></a>For this problem, I would suggest that a precision recall break-even threshold be selected. This ensures that we are right sizing the effort and not sacrificing either precision or recall. However, because this is a problem where recall is fundamental, I would also suggest investigating some negatives. This could be done by pure probability sampling or ordering by some measure like "probability<span class="sc">\*</span>amount".</span>
<span id="cb20-167"><a href="#cb20-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-170"><a href="#cb20-170" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb20-171"><a href="#cb20-171" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: threshold</span></span>
<span id="cb20-172"><a href="#cb20-172" aria-hidden="true" tabindex="-1"></a>pred<span class="ot">=</span><span class="fu">prediction</span>(<span class="at">predictions =</span> pred_valid, <span class="at">labels =</span> valid<span class="sc">$</span>suspicious_label)</span>
<span id="cb20-173"><a href="#cb20-173" aria-hidden="true" tabindex="-1"></a>perf<span class="ot">=</span><span class="fu">performance</span>(pred,<span class="at">measure =</span> <span class="st">"prbe"</span>)</span>
<span id="cb20-174"><a href="#cb20-174" aria-hidden="true" tabindex="-1"></a>thresh<span class="ot">=</span>perf<span class="sc">@</span>x.values[[<span class="dv">1</span>]][<span class="fu">which.max</span>(perf<span class="sc">@</span>y.values[[<span class="dv">1</span>]])]</span>
<span id="cb20-175"><a href="#cb20-175" aria-hidden="true" tabindex="-1"></a>tp<span class="ot">=</span><span class="fu">sum</span>((pred_valid<span class="sc">&gt;=</span>thresh) <span class="sc">&amp;</span> (valid<span class="sc">$</span>suspicious_label<span class="sc">==</span><span class="dv">1</span>))</span>
<span id="cb20-176"><a href="#cb20-176" aria-hidden="true" tabindex="-1"></a>tn<span class="ot">=</span><span class="fu">sum</span>((pred_valid<span class="sc">&lt;</span>thresh) <span class="sc">&amp;</span> (valid<span class="sc">$</span>suspicious_label<span class="sc">==</span><span class="dv">0</span>))</span>
<span id="cb20-177"><a href="#cb20-177" aria-hidden="true" tabindex="-1"></a>fp<span class="ot">=</span><span class="fu">sum</span>((pred_valid<span class="sc">&gt;=</span>thresh) <span class="sc">&amp;</span> (valid<span class="sc">$</span>suspicious_label<span class="sc">==</span><span class="dv">0</span>))</span>
<span id="cb20-178"><a href="#cb20-178" aria-hidden="true" tabindex="-1"></a>fn<span class="ot">=</span><span class="fu">sum</span>((pred_valid<span class="sc">&lt;</span>thresh) <span class="sc">&amp;</span> (valid<span class="sc">$</span>suspicious_label<span class="sc">==</span><span class="dv">1</span>))</span>
<span id="cb20-179"><a href="#cb20-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-180"><a href="#cb20-180" aria-hidden="true" tabindex="-1"></a>accuracy<span class="ot">=</span>(tn<span class="sc">+</span>tp)<span class="sc">/</span><span class="fu">nrow</span>(valid)</span>
<span id="cb20-181"><a href="#cb20-181" aria-hidden="true" tabindex="-1"></a>precision<span class="ot">=</span>tp<span class="sc">/</span>(tp<span class="sc">+</span>fp)</span>
<span id="cb20-182"><a href="#cb20-182" aria-hidden="true" tabindex="-1"></a>recall<span class="ot">=</span>tp<span class="sc">/</span>(tp<span class="sc">+</span>fn)</span>
<span id="cb20-183"><a href="#cb20-183" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Confusion Matrix"</span>)</span>
<span id="cb20-184"><a href="#cb20-184" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(<span class="at">pred=</span>pred_valid<span class="sc">&gt;=</span>thresh,<span class="at">actual=</span>valid<span class="sc">$</span>suspicious_label)</span>
<span id="cb20-185"><a href="#cb20-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-186"><a href="#cb20-186" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-187"><a href="#cb20-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-188"><a href="#cb20-188" aria-hidden="true" tabindex="-1"></a>In this case the threshold is <span class="in">`r round(thresh,3)`</span> for which accuracy is <span class="in">`r round(accuracy,3)`</span>, precision is <span class="in">`r round(precision,3)`</span> and recall is <span class="in">`r round(recall,3)`</span>. A priori, saying no one is suspicious, accuracy would be <span class="in">`r round(sum(valid$suspicious_label==0)/nrow(valid),3)`</span>.</span>
<span id="cb20-189"><a href="#cb20-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-190"><a href="#cb20-190" aria-hidden="true" tabindex="-1"></a><span class="fu">## Conclusions and further work</span></span>
<span id="cb20-191"><a href="#cb20-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-192"><a href="#cb20-192" aria-hidden="true" tabindex="-1"></a>This is in principle a good model, an AUC over 0.9, (much) improved accuracy and reasonable precision and recall.</span>
<span id="cb20-193"><a href="#cb20-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-194"><a href="#cb20-194" aria-hidden="true" tabindex="-1"></a>However, there are many amber to red flags which I believe make it a "no go".</span>
<span id="cb20-195"><a href="#cb20-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-196"><a href="#cb20-196" aria-hidden="true" tabindex="-1"></a>The model classifies quite well ids with no transaction information. Purely based on demographics, which raises potential discriminatory problems. In this case, only a limited range of ages is likely to be flagged as suspicious.</span>
<span id="cb20-197"><a href="#cb20-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-198"><a href="#cb20-198" aria-hidden="true" tabindex="-1"></a>The presence of postal code can also raise potential discriminatory issues. In countries where there is a long established record of race segregation, a postal code is a proxy for race and average income. And in other places, it could be a proxy for immigration status as well.</span>
<span id="cb20-199"><a href="#cb20-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-200"><a href="#cb20-200" aria-hidden="true" tabindex="-1"></a>Before thinking about deploying, I would really like to gather more historical transaction data, and also other indicators of a user's real financial situation, salary, mortgage, credit score, debt, etc. Also, I would like to understand why some ids with no transaction data are labeled as suspicious, is it historical? Have they defaulted previously? Are they in a collection process? Have they ever been?</span>
<span id="cb20-201"><a href="#cb20-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-202"><a href="#cb20-202" aria-hidden="true" tabindex="-1"></a>Once this is done and the new model has good performance, I would deploy by using a managed platform (Azure, AWS, GCP). This can be either a batch process or a REST API on a web service, depending on the need for real time predictions. The advantage of this approach is that you can have version control, rapid rollbacks etc, as well as the CI/CD environment. The steps are the usual, containerize the model and potentially the feature engineering (Docker), create the ETL flow (can also contain part of the feature engineering), schedule batch processing or serve the API.</span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>